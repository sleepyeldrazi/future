if (self.CavalryLogger) { CavalryLogger.start_js(["VXMzE"]); }

__d("FaceboxSourceConstants",[],(function a(b,c,d,e,f,g){f.exports={SNOWLIFT_SUGGEST:"snowlift_suggest",SNOWLIFT_DISMISS:"photo_snowlift_unit_suggestions",PERMALINK_SUGGEST:"permalink_suggest",PERMALINK_DISMISS:"photo_permalink_suggestions",UPLOADER_SUGGEST:"uploader_suggest",UPLOADER_DISMISS:"album_uploader_suggestions"};}),null);
__d("PhotoTagDataSourceType",[],(function a(b,c,d,e,f,g){f.exports={PRODUCT_ITEMS:"product_items",DEFAULT:"default"};}),null);
__d('PhotoTagApproval',['Arbiter','CSS','DOM','Event','Parent','PhotosConst','ge'],(function a(b,c,d,e,f,g){function h(i){'use strict';this.viewer=i;this.units=[];this.currentUnit=0;var j=i.getVersionConst();if(j==c('PhotosConst').VIEWER_SNOWLIFT){this._root=c('ge')('fbPhotoSnowliftTagApproval');}else this._root=c('ge')('fbPhotoPageTagApproval');c('Arbiter').subscribe(i.getEventString('DATA_CHANGE'),this.restartTagApproval.bind(this));c('Arbiter').subscribe('PhotoTagApproval.PENDING_TAG_PHOTO_CLICK',this.pendingTagPhotoClick.bind(this));c('Event').listen(this._root,'click',this.handleClick.bind(this));c('Event').listen(this._root,'mousemove',function(k){this.hiliteCurrentPendingTag();c('Event').kill(k);}.bind(this));this.restartTagApproval();}h.prototype.handleClick=function(event){'use strict';var i=event.getTarget();if(c('CSS').hasClass(i,'nextPager')&&c('CSS').hasClass(i,'enabled')){this.showNextUnit();}else if(c('CSS').hasClass(i,'prevPager')&&c('CSS').hasClass(i,'enabled')){this.showPrevUnit();}else if(c('Parent').byClass(i,'fbPhotoApprovalPendingButtons')){var j=this.units[this.currentUnit],k=this.getTagNameID(j);if(k){var l=c('Parent').byClass(i,'approve');c('Arbiter').inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:k,approve:l,version:this.viewer.getVersionConst()});}setTimeout(this.removeSelectedUnit.bind(this),0);}return true;};h.prototype.loadUnits=function(i){'use strict';this.units=c('DOM').scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){c('CSS').show(this._root);this.showUnit(i);c('CSS').conditionClass(this._root,'hidePagers',this.units.length==1);}else{c('CSS').hide(this._root);c('Arbiter').inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this.viewer.getVersionConst()});}};h.prototype.restartTagApproval=function(){'use strict';this.loadUnits(0);};h.prototype.pendingTagPhotoClick=function(i,j){'use strict';if(j.version!==c('PhotosConst').VIEWER_PERMALINK&&j.version!==c('PhotosConst').VIEWER_SNOWLIFT)return true;var k='approve:'+j.id;for(var l=0;l<this.units.length;l++)if(this.units[l].id===k){this.showUnit(l);return false;}return true;};h.prototype.removeSelectedUnit=function(){'use strict';var i=this.units[this.currentUnit];c('DOM').remove(i);this.loadUnits(this.currentUnit);};h.prototype.showNextUnit=function(){'use strict';this.showUnit(this.currentUnit+1);};h.prototype.showPrevUnit=function(){'use strict';this.showUnit(this.currentUnit-1);};h.prototype.getTagNameID=function(i){'use strict';var j=i.id.indexOf(':');return i.id.slice(j+1);};h.prototype.showUnit=function(i){'use strict';this.units.forEach(c('CSS').hide);this.currentUnit=(i+this.units.length)%this.units.length;var j=this.units[this.currentUnit];c('CSS').show(j);this.hiliteCurrentPendingTag();c('CSS').conditionClass(c('DOM').find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);c('CSS').conditionClass(c('DOM').find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);};h.prototype.hiliteCurrentPendingTag=function(){'use strict';var i=this.units[this.currentUnit],j=this.getTagNameID(i);c('Arbiter').inform('PhotoTagApproval.HILITE_TAG',{tag:j,version:this.viewer.getVersionConst()});};f.exports=h;}),null);
__d('legacy:photo-tag-approval',['PhotoTagApproval'],(function a(b,c,d,e,f,g){b.PhotoTagApproval=c('PhotoTagApproval');}),3);
__d("XFamilyBulkTagAddAsyncController",["XController"],(function a(b,c,d,e,f,g){f.exports=c("XController").create("\/family\/bulk_tag_save\/",{subject:{type:"Int"},save_tags:{type:"String"}});}),null);
__d('PhotoTagStore',['AsyncRequest','XFamilyBulkTagAddAsyncController','isEmpty'],(function a(b,c,d,e,f,g){function h(){'use strict';this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};h.instance=this;}h.prototype.getPhotoTags=function(i){'use strict';return this._tagList[i]||{};};h.prototype.photoHasTags=function(i){'use strict';return !c('isEmpty')(this.getPhotoTags(i));};h.prototype.clear=function(){'use strict';this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};};h.prototype.addTag=function(i,j,k,l){'use strict';i[j]=i[j]||{};var m=i[j][k]||[];m.push(l);i[j][k]=m;};h.prototype.revert=function(i){'use strict';var j=this._tagList,k=this._originalTagList;for(var l in j)if(c('isEmpty')(k[l][i])){j[l][i]=[];}else j[l][i]=k[l][i];this._dirtyPhotosByUid={};};h.prototype.hasNewTags=function(){'use strict';return !c('isEmpty')(this._tagList)||!c('isEmpty')(this._textTagList);};h.prototype.userHasDirtyTags=function(i){'use strict';return !c('isEmpty')(this._dirtyPhotosByUid[i]);};h.prototype.userDirtyTagsCount=function(i){'use strict';return Object.keys(this._dirtyPhotosByUid[i]).length;};h.prototype.handleTagFetch=function(i){'use strict';for(var j in i)this.loadTagInfo(j,i[j]);};h.prototype.saveAlbumTagsForUser=function(i,j){var k=arguments.length<=2||arguments[2]===undefined?false:arguments[2];'use strict';var l={},m=[],n=this._dirtyPhotosByUid[i]||{};for(var o in n){var p=this._tagList[o][i];if(c('isEmpty')(p)){m[m.length]=o;continue;}p.forEach(function(s){l[o]={x:s.x,y:s.y};});}var q={subject:i,action:'save',save_tags:l},r='/ajax/photos/album/tags.php';if(k){q={subject:i,save_tags:JSON.stringify(l)};r=c('XFamilyBulkTagAddAsyncController').getURIBuilder().getURI();}new (c('AsyncRequest'))().setURI(r).setData(q).setHandler(function(s){j(s.payload);}).setAllowCrossPageTransition(true).send();delete this._dirtyPhotosByUid[i];};h.prototype.getTagsFromList=function(i){'use strict';var j=[];for(var k in i)if(i.hasOwnProperty(k))for(var l in i[k])if(i[k].hasOwnProperty(l))i[k][l].forEach(function(m){return j.push(m);});return j;};h.prototype.getAllTags=function(){'use strict';var i=this.getTagsFromList(this._tagList),j=this.getTagsFromList(this._textTagList);return i.concat(j);};h.prototype.removeTag=function(i,j){'use strict';var k=this._tagList[i],l=this._originalTagList[i]||{};if(l[j]){this._dirtyPhotosByUid[j]=this._dirtyPhotosByUid[j]||{};this._dirtyPhotosByUid[j][i]=true;}else delete this._dirtyPhotosByUid[j][i];for(var m in k)if(m==j){var n=this._tagList[i][m];delete this._tagList[i][m];if(c('isEmpty')(this._tagList[i]))delete this._tagList[i];return n;}};h.prototype.removeTextTag=function(i,j){'use strict';var k=this._textTagList[i];if(!c('isEmpty')(k[j])){var l=this._textTagList[i][j];this._textTagList[i][j]=[];if(c('isEmpty')(this._textTagList[i]))delete this._textTagList[i];return l;}return [];};h.prototype.removeAllNewTagsOfUser=function(i){'use strict';var j=[];if(!this.userHasDirtyTags(i))return j;var k=this._dirtyPhotosByUid[i];for(var l in k)j=j.concat(this.removeTag(l,i));return j;};h.prototype.removeAllTagsFromPhoto=function(i){'use strict';var j=[];if(!c('isEmpty')(this._tagList[i]))for(var k in this._tagList[i]){if(!this._tagList[i].hasOwnProperty(k))continue;j=j.concat(this.removeTag(i,k));}if(!c('isEmpty')(this._textTagList[i]))for(var l in this._textTagList[i]){if(!this._textTagList[i].hasOwnProperty(l))continue;j=j.concat(this.removeTextTag(i,l));}return j;};h.prototype.storeTag=function(i,j,k,l,m){'use strict';this.storeTagWithOptions(i,j,k,l,{can_remove:m});};h.prototype.storeTagWithOptions=function(i,j,k,l,m){'use strict';this._dirtyPhotosByUid[j]=this._dirtyPhotosByUid[j]||{};this._dirtyPhotosByUid[j][i]=true;var n={x:k,y:l};Object.assign(n,m);if(!j){this.addTag(this._textTagList,i,n.name,n);}else this.addTag(this._tagList,i,j,n);};h.prototype.loadTagInfo=function(i,j){'use strict';this._tagList[i]={};this._originalTagList[i]={};for(var k=0;k<j.length;k++){var l=j[k];this.addTag(this._tagList,i,l.subject,l);this.addTag(this._originalTagList,i,l.subject,l);}};h.getInstance=function(){'use strict';if(h.instance===null)new h();return h.instance;};h.instance=null;f.exports=h;}),null);
__d("PhotosTaggingWaterfall",["AsyncSignal"],(function a(b,c,d,e,f,g){function h(i){h._queueName=i||h._queueName;}Object.assign(h,{BEGIN:"begin",TAG_FACE:"tag_face",HOVER_TAG_FACE:"hover_tag_face",SHOW_SUGGEST:"show_suggest",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function i(j,k){new (c("AsyncSignal"))('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(j)}).setHandler(k).send();}});f.exports=h;}),null);
__d('PhotoTagger',['csx','Arbiter','AsyncRequest','AsyncResponse','CSS','DOM','DOMQuery','Event','FaceboxSourceConstants','Hovercard','Keys','LegacyMentionsInput.react','Parent','PhotosConst','PhotosTaggingWaterfall','PhotosUtils','PhotoTagStore','PhotoTagDataSourceType','PhotoTaggingQE','QE2Logger','React','ReactDOM','Style','UFIAddCommentController','UFICentralUpdates','UFIContainer.react','UFIComment.react','URI','Vector','WWWBase','getElementPosition','removeFromArray'],(function a(b,c,d,e,f,g,h){var i=c('PhotoTaggingQE').position==='beside_centered';function j(l,m){return (l%m+m)%m;}function k(l){'use strict';this.viewer=l;this.version=l.getVersionConst();this.datasources={};this.photoData={};this.tagRects={};this.ajaxURIs={tagsInit:'/ajax/photos/photo/tags/tags_init.php',tagsAlbum:'/ajax/photos/photo/tags/tags_album.php',fetchDatasource:'/ajax/photos/photo/tags/fetch_datasource.php',tagAction:'/ajax/photo_tagging_ajax.php',tagWithAction:'/ajax/with_tagging_ajax.php'};this.recognizedUsers=[];this.addedSuggestions=[];this.featuredSuggestions=[];this.albumSuggestions=[];this.friendSuggestions=[];this.suggestionAlbum=-1;this.addCommentController=null;k.instances[this.version]=this;}k.prototype.initSnowlift=function(l,m,n,o){'use strict';this._init(l,m,n,this.viewer.container,o);};k.prototype.initPermalink=function(l,m,n){'use strict';this._init(l,m,n,this.viewer.actionList);};k.prototype._init=function(l,m,n,o,p){'use strict';this.root=this.viewer.getRoot();this.tagger=l;this.tokenizer=m;this.ufi=p;this._qn=null;this.typeahead=m.getTypeahead();this.userId=n;this.makeProfilePicMenuContainer=o;this.faceboxes=[];this.tags=[];this.currentFacebox=null;this.currentTextbox=null;this.revokedFaceboxes=[];this.requestFaceboxNextTag=false;this.clickState=c('DOM').find(this.root,'div.stageActions');this.newTagBox=c('DOM').find(this.clickState,'div.newTagBox');this.addTagLink=c('DOM').find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=c('DOM').find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.needAlbumSuggestionsFetch=true;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());this.updateFaceboxes();this.tagAccumulating=false;return this;};k.prototype.setTagAccumulator=function(l){'use strict';this.tagAccumulating=l;};k.prototype.fetchTaggingSuggestions=function(l){'use strict';var m=new (c('URI'))(c('WWWBase').uri).setPath(this.ajaxURIs.tagsInit);new (c('AsyncRequest'))().setAllowCrossPageTransition(true).setAllowCrossOrigin(true).setURI(m).setData(l).setOption('retries',1).setHandler(function(o){var p=o.getPayload();this.featuredSuggestions=p.featuredTaggees;this.friendSuggestions=p.friendTaggees;this.updateTypeaheadSuggestions();}.bind(this)).send();var n=this.typeahead.subscribe('bootstrap',function(o,p){if(p&&!p.bootstrapping){if(this.taggingMode)this.updateWithSuggestions();this.typeahead.unsubscribe(n);this.typeahead.subscribe('focus',function(){if(this.taggingMode)this.updateWithSuggestions();}.bind(this));this.typeahead.subscribe('click',function(){if(!this.taggingMode)this.updateWithSuggestions();}.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(q,r){if(this.taggingMode&&r&&!r.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));};k.prototype.fetchAlbumTaggingSuggestions=function(){'use strict';new (c('AsyncRequest'))().setURI(this.ajaxURIs.tagsAlbum).setData({cachedAlbum:this.suggestionAlbum,photo:this.photoData.fbid}).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(l){this.needAlbumSuggestionsFetch=false;var m=l.getPayload();if(m.length===0)return;this.suggestionAlbum=m.album;this.albumSuggestions=m.taggees;this.updateTypeaheadSuggestions();}.bind(this)).send();};k.prototype.resetAlbumTaggingSuggestions=function(){'use strict';this.needAlbumSuggestionsFetch=true;this.updateTypeaheadSuggestions();};k.prototype.updateTypeaheadSuggestions=function(){'use strict';this.typeahead.getView().setSuggestions(this.addedSuggestions.concat(this.recognizedUsers,this.featuredSuggestions,this.needAlbumSuggestionsFetch?[]:this.albumSuggestions,this.friendSuggestions));};k.prototype.saveClickPosition=function(l,m){'use strict';var n=c('Vector').getElementPosition(l),o=c('Vector').getElementDimensions(l);this.clickPercentToPhoto=new (c('Vector'))((m.x-n.x)/o.x,(m.y-n.y)/o.y);};k.prototype.getCalculatedClickPosition=function(l){'use strict';var m=c('Vector').getElementPosition(l),n=c('Vector').getElementDimensions(l);if(n.x===0||n.y===0)return null;return new (c('Vector'))(this.clickPercentToPhoto.x*n.x+m.x,this.clickPercentToPhoto.y*n.y+m.y,'document');};k.prototype.repositionTagger=function(){'use strict';if(this.clickPercentToPhoto){var l=this.viewer.getImage(),m=this.getCalculatedClickPosition(l);if(!m)return;this.addTagFromClickPos(m);}};k.prototype.setupHandlers=function(){'use strict';this.handlers=[c('Event').listen(this.clickState,'click',this.addTag.bind(this)),c('Event').listen(this.addTagLink,'click',this.checkActions.bind(this)),c('Event').listen(this.overlayActions,'click',this.checkActions.bind(this))];this.setupAddTagHandlers();c('Event').listen(document.documentElement,'keydown',function(event){if(!this.taggingMode)return;var l=c('Event').getKeyCode(event);if(l===c('Keys').ESC){this.deactivateTagging();}else if(l===c('Keys').TAB)this.addNextTagFromFacebox(event.shiftKey?-1:1);}.bind(this));this.subscriptions=[c('Arbiter').subscribe(this.viewer.getEventString('PAGE'),this.restartTagging.bind(this)),c('Arbiter').subscribe(this.viewer.getEventString('DATA_CHANGE'),this.setPhotoData.bind(this)),c('Arbiter').subscribe(this.viewer.getEventString('EXTRA_DATA_CHANGE'),this.setExtraData.bind(this)),c('Arbiter').subscribe(this.viewer.getEventString('CLOSE'),this.deactivateTagging.bind(this))];c('UFICentralUpdates').subscribe('update-comments',function(l,m){if(m.comments&&m.comments.length)this.commentAdded(m.comments,m.payloadsource);}.bind(this));this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));};k.prototype.setupAddTagHandlers=function(){'use strict';if(this.ufi){var l=c('DOM').scry(this.root,'.tagPhotoLink');l.forEach(function(m){c('Event').listen(m,'click',this.showTaggerFromClick.bind(this));},this);}};k.prototype.updateWithSuggestions=function(l,m){'use strict';var n=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!n.length)return;var o=this.typeahead.getData().respond('',n);for(var p=0;p<o.length;p++)o[p].index=-1000+p;};k.prototype.addSuggestion=function(l,m){'use strict';var n=m.info&&m.info.uid;if(n){this.addedSuggestions.unshift(n);this.updateTypeaheadSuggestions();}};k.prototype.setQueueName=function(l){'use strict';this._qn=l;return this;};k.prototype._sendWaterfallLogSignal=function(l){'use strict';c('PhotosTaggingWaterfall').sendSignal({qn:this._qn,source:this.viewer.getSourceString(),step:l,pid:this.photoData.pid});};k.prototype._sendFaceboxSuggestionLogSignal=function(l,m,n){'use strict';c('PhotosTaggingWaterfall').sendSignal({step:c('PhotosTaggingWaterfall').SHOW_SUGGEST,photo_owner:this.photoData.owner,tagee:l,is_first:true,source:m,photo_id:this.photoData.fbid,facebox_id:n});};k.prototype._bumpQueueName=function(){'use strict';if(this._qn)this._qn+=1;};k.prototype.activateTagging=function(){'use strict';c('Arbiter').inform('PhotoTagger.ACTIVATE_TAGGING');if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new (c('AsyncRequest'))(this.ajaxURIs.fetchDatasource).setData({fbid:this.photoData.fbid,version:this.version,data_source_type:this.dataSourceType}).send();if(this.needAlbumSuggestionsFetch)this.fetchAlbumTaggingSuggestions();};k.prototype.restartTagging=function(){'use strict';this.hideNewTag();this.hideTagger();this.hideExistingTags();this.revokedFaceboxes=[];this.setCurrentFacebox(null);if(this.taggingMode){this.requestFaceboxNextTag=true;this.activateTagging();}};k.prototype.getDataSource=function(){'use strict';return this.datasources[this.getDataSourceKey()];};k.prototype.getDataSourceKey=function(){'use strict';var l;if(this.photoData.ownertype=='user'&&!this.photoData.obj_id){l='friends';}else l=this.photoData.obj_id||this.photoData.owner;if(this.dataSourceType===c('PhotoTagDataSourceType').PRODUCT_ITEMS)return l+'_products';return l;};k.prototype.setDataSource=function(l){'use strict';if(this.typeahead.getData()!=l)this.typeahead.swapData(l);this.datasources[this.getDataSourceKey()]=l;};k.prototype.dataSourceFetched=function(l){'use strict';this.taggingMode=true;c('CSS').addClass(this.root,'taggingMode');this._hidePivots();c('Arbiter').inform('PhotoTagger.ACTIVATED_TAGGING');this._bumpQueueName();this._sendWaterfallLogSignal(c('PhotosTaggingWaterfall').BEGIN);this.setDataSource(l);};k.prototype.deactivateTagging=function(){'use strict';if(this.taggingMode===true)this._sendWaterfallLogSignal(c('PhotosTaggingWaterfall').FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();this.hideExistingTags();this.setCurrentFacebox(null);this._showPivots();c('CSS').removeClass(this.root,'taggingMode');c('Arbiter').inform('PhotoTagger.DEACTIVATED_TAGGING');};k.prototype._hidePivots=function(){'use strict';var l=c('DOMQuery').scry(this.root,'.tag');for(var m=0;m<l.length;m++)c('CSS').hide(l[m]);};k.prototype._showPivots=function(){'use strict';var l=c('DOMQuery').scry(this.root,'.tag');for(var m=0;m<l.length;m++)c('CSS').show(l[m]);};k.prototype.checkActions=function(event){'use strict';var l=event.getTarget(),m=c('Parent').byClass(l,'fbPhotosPhotoActionsTag'),n=c('Parent').byClass(l,'fbPhotosPhotoActionsProductTag');if(m||n)if(this.taggingMode){this.deactivateTagging();}else{this.dataSourceType=n?c('PhotoTagDataSourceType').PRODUCT_ITEMS:c('PhotoTagDataSourceType').DEFAULT;this.activateTagging();this.addNextTagFromFacebox(1);}};k.prototype.hideTagger=function(){'use strict';c('CSS').hide(this.tagger);this.clickPercentToPhoto=null;var l=c('DOM').scry(this.tagger,'input.textInput')[0];if(l)l.blur();};k.prototype.showTaggerFromClick=function(){'use strict';var l=event.getTarget(),m=c('Parent').byClass(l,'tagPhotoLink'),n=m.getAttribute('data-x'),o=m.getAttribute('data-y');if(n!==null&&o!==null){var p=new (c('Vector'))(n,o),q=this.viewer.getImage();p=c('PhotosUtils').normalizedToAbsolutePosition(q,p);this.setClickPosAndFacebox(p);this.addTagFromClickPos(p);}this.showTagger();};k.prototype.showTagger=function(){'use strict';c('QE2Logger').logExposureForUser('www_snowlift_photo_tagger_qe');c('DOM').scry(this.root,'.fbPhotosPhotoTagboxBase').forEach(function(q){c('CSS').removeClass(q,'hover');c('CSS').removeClass(q,'tagClick');if(this.taggingMode)c('CSS').hide(c('DOM').find(q,'.tag'));},this);var l=c('DOM').find(this.tagger,'.typeaheadContainer'),m=c('DOM').find(l,'.arrow .nub'),n=3;if(!i){c('Style').set(l,'margin-left',0);c('Style').set(m,'margin-left',0);}var o=c('getElementPosition')(l);if(o.x<=0)if(!i&&!c('CSS').hasClass(this.tagger,'fbPhotoTaggerFlipped')){c('Style').set(l,'margin-left',-2*o.x+'px');c('Style').set(m,'margin-left',o.x-n+'px');}if(this.ufi){var p=c('DOM').find(this.tagger,"._12nb");c('CSS').show(l);c('CSS').hide(p);}c('CSS').show(this.tagger);setTimeout(function(){c('DOM').find(this.tagger,'input.textInput').focus();}.bind(this),0);this.hideNewTag();c('Arbiter').inform('reflow');};k.prototype.showNewTag=function(l,m){'use strict';if(m&&this.ufi){c('CSS').addClass(m,'hover');c('DOM').find(m,'.uiLinkButtonInput').value=l;return;}if(!this.newTagBox)return;c('DOM').setContent(c('DOM').find(this.newTagBox,'div.tagName'),c('DOM').create('span',null,l));c('CSS').show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);};k.prototype.hideNewTag=function(){'use strict';if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}c('CSS').hide(this.newTagBox);};k.prototype.getTaggerPositioningOrigin=function(){'use strict';return c('Vector').getElementPosition(this.clickState,'document');};k.prototype.setClickPosAndFacebox=function(l){'use strict';var m=this.viewer.getImage();this.saveClickPosition(m,l);var n=c('PhotosUtils').absoluteToNormalizedPosition(m,l);this.setCurrentFacebox(this.findNearestFacebox(n));};k.prototype.addTagFromClickPos=function(l){'use strict';this.currentTextbox=null;this.hideExistingTags();if(this.currentFacebox){this.addTagFromFaceboxDontSave(this.currentFacebox);}else{var m=this.viewer.getImage(),n=c('PhotosUtils').absoluteToNormalizedPosition(m,l);if(this.tags!==undefined)for(var o=0;o<this.tags.length;o++)if(this.tags[o].rect.contains(n)){this.showExistingTag(this.tags[o]);this.currentTextbox=this.tags[o];}this.removeSuggestionFromTagger();c('CSS').removeClass(c('DOM').find(this.tagger,'.faceBox'),'faceBoxHidden');if(this.currentTextbox){var p=this.currentTextbox.rect.w()/100*c('Vector').getElementDimensions(m).x;this.addTagFromPosition(l,p);}else this.addTagFromPosition(l,this.TAG_BOX_SIZE);}};k.prototype.showExistingTag=function(l){'use strict';if(this.taggingMode){this._hidePivots();c('CSS').show(c('DOM').find(l.node,'.tag'));c('CSS').addClass(l.node,'tagClick');}else c('CSS').addClass(l.node,'hover');this.hideTagger();};k.prototype.hideExistingTags=function(){'use strict';var l=c('DOM').scry(this.root,'.tagClick');l&&l.forEach(function(m){c('CSS').removeClass(m,'tagClick');if(this.taggingMode)c('CSS').hide(c('DOM').find(m,'.tag'));}.bind(this));};k.prototype.addTag=function(event){'use strict';var l=event.getTarget(),m=c('Parent').byClass(l,'fbPhotosPhotoButtons');if(!this.taggingMode||m&&l!==m||c('Parent').byClass(l,'fbPhotosPhotoActions')||c('Parent').byClass(l,'faceboxSuggestion')||c('Parent').byClass(l,'photoTagTypeahead')||c('Parent').byClass(l,'tagUfi'))return;var n=c('Vector').getEventPosition(event);this.setClickPosAndFacebox(n);this.addTagFromClickPos(n);};k.prototype.showTagIfCommentAdded=function(){'use strict';if(this.taggingMode){var l=this.getClickPointForSave(),m=c('Vector').from(l.x,l.y);if(l!==null)for(var n=0;n<this.tags.length;n++)if(this.tags[n].rect.contains(m)){this.showExistingTag(this.tags[n]);this.hideTagger();return;}}};k.prototype.commentAdded=function(l,m){'use strict';l.forEach(function(n){var o=this.getClickPointForSave(),p=null;if(n.isPhotoTag&&(n.photoTextTagID===null||n.photoTextTagID===undefined)&&n.photoTagX!==null&&n.photoTagY!==null)if(o!==null&&n.photoTagX===o.x&&n.photoTagY===o.y){p=c('DOM').find(this.tagger,"._12nb");}else{var q=new (c('Vector'))(n.photoTagX,n.photoTagY),r=this.findNearestTag(q);if(r!==null)p=c('DOM').find(r.node,"._12nb");}if(p!==null){var s=c('DOM').find(p,'.UFIContainer'),t={};t[n.author]={id:n.author};c('ReactDOM').render(c('React').createElement(c('UFIContainer.react'),null,c('React').createElement(c('UFIComment.react'),{comment:n,authorProfiles:t,feedback:{},contextArgs:{}})),s);c('Style').set(c('DOM').find(p,'.UFIAddComment'),'opacity',.5);c('DOM').find(p,'textarea').setAttribute('disabled','disabled');}},this);};k.prototype.showTaggerUFI=function(event){'use strict';var l=c('DOM').find(this.tagger,'.typeaheadContainer'),m=c('DOM').find(this.tagger,"._12nb"),n=c('DOM').find(m,'.arrow .nub'),o=3,p=c('getElementPosition')(m);if(!i)if(p.x<=0&&!c('CSS').hasClass(this.tagger,'fbPhotoTaggerFlipped')){c('Style').set(m,'margin-left',-2*p.x+'px');c('Style').set(n,'margin-left',p.x-o+'px');}else{c('Style').set(m,'margin-left',0);c('Style').set(n,'margin-left',0);}var q=this.getClickPointForSave(),r=c('DOM').find(m,'.tagUfiAddComment'),s=c('DOM').find(this.viewer.ufiInputContainer,'input[name="ft_ent_identifier"]'),t={ftentidentifier:s.value,source:r.getAttribute('data-source'),mentionsinput:{inputComponent:c('LegacyMentionsInput.react')},hideActorPhoto:true,isPhotoTag:true,photoFBID:this.viewer.getCurrentPhotoInfo().fbid,photoTagX:q.x,photoTagY:q.y};this.addCommentController=c('UFIAddCommentController').factory(r,t);var u=c('DOM').find(m,'.UFIContainer');if(u.firstChild!==null)c('DOM').remove(u.firstChild);c('Style').set(c('DOM').find(m,'.UFIAddComment'),'opacity',1);c('DOM').find(m,'textarea').removeAttribute('disabled');c('CSS').show(this.tagger);c('CSS').hide(l);c('CSS').show(m);c('Arbiter').inform('reflow');};k.prototype._findNearest=function(l,m){'use strict';var n=Infinity,o=null;l.forEach(function(p){if(p.rect.contains(m)){var q=m.distanceTo(p.rect.getCenter());if(q<n){n=q;o=p;}}});return o;};k.prototype.findNearestFacebox=function(l){'use strict';return this._findNearest(this.faceboxes,l);};k.prototype.findNearestTag=function(l){'use strict';return this._findNearest(this.tags,l);};k.prototype.addNextTagFromFacebox=function(l){'use strict';if(this.faceboxes.length===0)return;if(!this.currentFacebox){this.setCurrentFacebox(this.faceboxes[0]);}else{var m=this.faceboxes.indexOf(this.currentFacebox),n=j(m+l,this.faceboxes.length);if(n===m)return;this.setCurrentFacebox(this.faceboxes[n]);}this.addTagFromFacebox(this.currentFacebox);};k.prototype.addTagFromFaceboxDontSave=function(l){'use strict';c('CSS').addClass(l.node,'active');c('CSS').addClass(c('DOM').find(this.tagger,'.faceBox'),'faceBoxHidden');var m=l.rect.getCenter(),n=this.viewer.getImage(),o=c('PhotosUtils').normalizedToAbsolutePosition(n,m),p=l.rect.w()/100*c('Vector').getElementDimensions(n).x;if(l.rect.w()>this.HUGE_FACE_THRESH&&l.rect.h()>this.HUGE_FACE_THRESH)p*=this.HUGE_FACE_SHRINK_FACTOR;var q=this.getFaceboxSuggestionFromFaceboxElem(l.node);if(q){var r=this.version===c('PhotosConst').VIEWER_PERMALINK?c('FaceboxSourceConstants').PERMALINK_DISMISS:c('FaceboxSourceConstants').SNOWLIFT_DISMISS;this.addSuggestionToTagger(l,q);this._sendFaceboxSuggestionLogSignal(q.getAttribute('data-id'),r,l.id);}else this.removeSuggestionFromTagger();this.addTagFromPosition(o,p);return o;};k.prototype.getFaceboxSuggestionFromFaceboxElem=function(l){'use strict';return c('DOM').scry(l,"._570u")[0];};k.prototype.addSuggestionToTagger=function(l,m){'use strict';this.removeSuggestionFromTagger();c('CSS').addClass(this.tagger,'suggestionActive');var n=c('DOM').find(this.tagger,'.typeaheadContainer'),o=m.cloneNode(true);this.stripReactID(o);c('DOM').appendContent(n,o);this.setupFaceboxSuggestionHandlers(l,o);};k.prototype.stripReactID=function(l){'use strict';l.removeAttribute('data-reactid');for(var m=0;m<l.children.length;m++)this.stripReactID(l.children[m]);};k.prototype.removeSuggestionFromTagger=function(){'use strict';c('CSS').removeClass(this.tagger,'suggestionActive');var l=c('DOM').scry(this.tagger,'.faceboxSuggestion');l&&l.forEach(function(m){c('DOM').remove(m);});};k.prototype.dismissFaceboxSuggestion=function(l,m,n,o){'use strict';new (c('AsyncRequest'))().setURI('/ajax/dismiss_tag_suggest.php').setMethod('POST').setData({facebox_logs:[{facebox:l,log_data:{photo_owner:n,tagee:m,is_first:true}}],closing_source:o,closing_action:'no'}).setAllowCrossPageTransition(true).send();};k.prototype.addTagFromFacebox=function(l){'use strict';this.currentTextbox=null;var m=this.addTagFromFaceboxDontSave(l),n=this.viewer.getImage();this.saveClickPosition(n,m);};k.prototype.addTagFromPosition=function(l,m){'use strict';var n=this.viewer.getImage(),o=this.calcTaggerPosition(n,l,m);this.calcClickPoint(n,l);if(!o){this.hideTagger();return;}o.setElementPosition(this.tagger);if(this.newTagBox){o.setElementPosition(this.newTagBox);new (c('Vector'))(m,m).setElementDimensions(this.newTagBox);}var p=c('Vector').getElementPosition(n),q=c('Vector').getElementDimensions(n),r=this.typeahead.getView();if(i){c('CSS').addClass(this.tagger,'fbPhotoTaggerExperimental');r.addTypeaheadFlip('fbPhotoTaggerTypeaheadViewExperimental');var s=p.x+q.x*.5;c('CSS').conditionClass(this.tagger,'fbPhotoTaggerLeftExperimental',l.x>s);c('CSS').conditionClass(this.tagger,'fbPhotoTaggerRightExperimental',l.x<=s);}else if(l.y>p.y+q.y*3/4){c('CSS').addClass(this.tagger,'fbPhotoTaggerFlipped');r.addTypeaheadFlip('fbPhotoTaggerFlipped');if(l.x>p.x+q.x*1/2){this.flipRules('fbPhotoTaggerRight','fbPhotoTaggerLeft',r);}else this.flipRules('fbPhotoTaggerLeft','fbPhotoTaggerRight',r);}else{c('CSS').removeClass(this.tagger,'fbPhotoTaggerFlipped');c('CSS').removeClass(this.tagger,'fbPhotoTaggerLeft');c('CSS').removeClass(this.tagger,'fbPhotoTaggerRight');r.removeTypeaheadFlip('fbPhotoTaggerFlipped');r.removeTypeaheadFlip('fbPhotoTaggerLeft');r.removeTypeaheadFlip('fbPhotoTaggerRight');}if(!this.taggingMode||this.currentTextbox===null)if(this.ufi&&this.currentFacebox===null){this.showTaggerUFI();}else this.showTagger();if(this.taggingMode){this._sendWaterfallLogSignal(c('PhotosTaggingWaterfall').TAG_FACE);}else this._sendWaterfallLogSignal(c('PhotosTaggingWaterfall').HOVER_TAG_FACE);};k.prototype.flipRules=function(l,m,n){'use strict';c('CSS').addClass(this.tagger,l);c('CSS').removeClass(this.tagger,m);n.addTypeaheadFlip(l);n.removeTypeaheadFlip(m);};k.prototype.calcTaggerPosition=function(l,m,n,o){'use strict';o=o||n;var p=c('Vector').getElementPosition(l),q=c('Vector').getElementDimensions(l),r=new (c('Vector'))(n/2,o/2),s=m.sub(p);for(var t in {x:1,y:1}){if(m[t]<p[t]||m[t]>p[t]+q[t])return null;var u=t==='x'?n:o;if(s[t]<u/2){r[t]=s[t];}else if(q[t]<s[t]+u/2)r[t]=u-(q[t]-s[t]);}var v=3,w=c('DOM').find(this.tagger,'.faceBox');c('Style').set(w,'width',n-v*2+'px');c('Style').set(w,'height',o-v*2+'px');var x=m.sub(this.getTaggerPositioningOrigin());return x.sub(r.x,r.y);};k.prototype.calcClickPoint=function(l,m){'use strict';var n=c('Vector').getElementDimensions(l),o=c('Vector').getElementPosition(l),p=m.sub(o);this.clickPoint={x:p.x/n.x,y:p.y/n.y};};k.prototype.getClickPointForSave=function(){'use strict';if(this.clickPoint===undefined)return null;return {x:this.clickPoint.x*100,y:this.clickPoint.y*100};};k.prototype.getCurrentOrientationForSave=function(){'use strict';if(!this.viewer.isSpherical()){return null;}else{var l=this.viewer.getOrientation(),m=l.yaw,n=l.pitch;return {yaw:m,pitch:n};}};k.prototype.getTaggingDataForSave=function(l,m){'use strict';var n=this.getTaggingData('add',l.isFreeform()?'':l.getValue(),l.getText(),m),o=this.getClickPointForSave();n.x=o.x;n.y=o.y;n.from_facebox=!!this.currentFacebox;n.tagging_mode=!!this.taggingMode;var p=this.getCurrentOrientationForSave();if(p){n.yaw=p.yaw;n.pitch=p.pitch;}return n;};k.prototype.saveTag=function(l,m,n){'use strict';var o=this.getTaggingDataForSave(m,n);if(this.tagAccumulating){c('PhotoTagStore').getInstance().storeTagWithOptions(this.photoData.fbid,o.subject,o.x,o.y,o);}else new (c('AsyncRequest'))().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(o).setAllowCrossPageTransition(true).setHandler(this.tagsChangeHandler.bind(this)).setErrorHandler(this.checkError.bind(this,m)).send();var p=this.userId===o.subject;if(p){var q=c('DOM').scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(q.length===1){var r=q[0];c('CSS').removeClass(r,'hide');}}var s=new (c('Vector'))(o.x,o.y),t=this.findNearestTag(s);if(t&&t.rect.contains(s)){this.showNewTag(m.getText(),t.node);}else this.showNewTag(m.getText());this.hideTagger();var u=this.currentFacebox;if(u){if(this.taggingMode)this.addNextTagFromFacebox(1);this.removeFacebox(u);}c('Arbiter').inform('PhotoTagger.ADDING_TAG',{subject:o.subject,text:m.getText()});c('Arbiter').inform('PhotoTagger.SAVE_TAG',{photo_fbid:this.photoData.fbid,self_tag:p});};k.prototype.getTaggingData=function(l,m,n,o){'use strict';return {cs_ver:this.version,pid:this.photoData.pid,fbid:this.photoData.fbid,id:this.photoData.owner,subject:m,name:n,action:l,source:o?o:this.viewer.getSourceString(),qn:this._qn,position:this.getPosition(),slsource:this.viewer.getViewerSource(),slset:this.viewer.getViewerSet()};};k.prototype.getPosition=function(){'use strict';return this.viewer.getPosition();};k.prototype.tagsChangeHandler=function(l){'use strict';};k.prototype.checkError=function(l,m){'use strict';if(m.getPayload()&&m.getPayload().clear_tag){l.already_untagged=true;this.tokenizer.removeToken(l);}c('AsyncResponse').defaultErrorHandler(m);};k.prototype.removeTag=function(l,m,n){'use strict';if(m.already_untagged)return;var o='remove';if(c('DOM').scry(m.element,'a.pending')[0])o='retract';if(m.blockUser)o='remove_block';if(this.tagAccumulating){if(m.isFreeform()){c('PhotoTagStore').getInstance().removeTextTag(this.photoData.fbid,m.getInfo().text);}else c('PhotoTagStore').getInstance().removeTag(this.photoData.fbid,m.getInfo().uid);}else new (c('AsyncRequest'))().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData(o,m.isFreeform()?'':m.getInfo().uid,m.getInfo().text)).setHandler(function(r){this.tagsChangeHandler(r);n&&n();}.bind(this)).setAllowCrossPageTransition(true).send();if(this.userId===parseInt(m.getValue(),10)&&this.userId!==this.viewer.getCurrentPhotoInfo().owner){var p=c('DOM').scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(p.length===1){var q=p[0];c('CSS').addClass(q,'hide');}c('Arbiter').inform('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION');}};k.prototype.removeTagByID=function(l,m,n){'use strict';var o=this.tokenizer.tokens;for(var p=0;p<o.length;p++)if(o[p].info.uid==m)return this.removeTag(null,o[p],n);};k.prototype.removeTagByIDFromHovercardLink=function(l,m,n){'use strict';this.removeTagByID(l,m,function(){if(c('Hovercard').contains(n))c('Hovercard').hide(true);});};k.prototype.removeWithTag=function(l,m){'use strict';new (c('AsyncRequest'))().setURI(this.ajaxURIs.tagWithAction).setMethod('POST').setData({action:'remove_with',taggee:m,tag:l,version:this.version,fbid:this.photoData.fbid}).setHandler(function(n){this.tagsChangeHandler(n);c('Hovercard').hide(true);}.bind(this)).setAllowCrossPageTransition(true).send();};k.prototype.setPhotoData=function(l,m){'use strict';this.clickPercentToPhoto=null;this.photoData=m;return this;};k.prototype.setExtraData=function(l,m){'use strict';this.tagRects=m.tagRects;this.updateFaceboxes();this.setupAddTagHandlers();this._setInitialFaceboxFromID(m);if(m.openTag)setTimeout(function(){this.activateTagging();this._setInitialFaceboxFromID(m);if(this.faceboxes.length===1){this.addTagFromFacebox(this.currentFacebox);}else this.addNextTagFromFacebox(1);}.bind(this),0);return this;};k.prototype._setInitialFaceboxFromID=function(l){'use strict';if(l.initialFaceboxID!==null&&this.faceboxes.length!==0){var m=this.getFacebox(l.initialFaceboxID);if(m!==null){var n=this.faceboxes.indexOf(m);n=j(n-1,this.faceboxes.length);this.setCurrentFacebox(this.faceboxes[n]);}}};k.prototype.markTagAsSpam=function(l,m){'use strict';new (c('AsyncRequest'))().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData('mark_as_spam',m,null)).send();};k.prototype.removeFacebox=function(l){'use strict';if(l===null)return;this.revokedFaceboxes.push(l.rect.getCenter());c('removeFromArray')(this.faceboxes,l);c('DOM').remove(l.node);if(l===this.currentFacebox)this.setCurrentFacebox(null);};k.prototype.setCurrentFacebox=function(l){'use strict';if(this.currentFacebox)c('CSS').removeClass(this.currentFacebox.node,'active');this.currentFacebox=l;if(l){this.recognizedUsers=JSON.parse(l.node.getAttribute('data-recognizeduids'));this.updateTypeaheadSuggestions();}};k.prototype.updateRevokedFaceboxes=function(){'use strict';this.revokedFaceboxes=this.revokedFaceboxes.filter(function(l){for(var m=0;m<this.faceboxes.length;++m){var n=this.faceboxes[m],o=l.distanceTo(n.rect.getCenter());if(o<this.EPSILON)return true;}return false;}.bind(this));this.revokedFaceboxes.forEach(function(l){var m=this.findNearestFacebox(l);c('removeFromArray')(this.faceboxes,m);c('DOM').remove(m.node);}.bind(this));};k.prototype.updateFaceboxes=function(){'use strict';this.faceboxes=[];this.tags=[];for(var l in this.tagRects){var m;if(c('PhotosUtils').isFacebox(l)){m=this.faceboxes;}else if(c('PhotosUtils').isTag(l))m=this.tags;if(m){var n='container';if(this.version===c('PhotosConst').VIEWER_PERMALINK)n='root';var o=c('DOM').scry(this.viewer[n],'#'+l);if(o.length>0)m.push({node:o[0],id:l,rect:this.tagRects[l]});}this.showTagIfCommentAdded();}this.updateRevokedFaceboxes();this.faceboxes.sort(function(q,r){return q.rect.getCenter().x-r.rect.getCenter().x;});if(this.currentFacebox){var p=this.currentFacebox.rect.getCenter();this.setCurrentFacebox(this.findNearestFacebox(p));c('CSS').addClass(this.currentFacebox.node,'active');}if(this.requestFaceboxNextTag){this.addNextTagFromFacebox(1);this.requestFaceboxNextTag=false;}};k.prototype.getFacebox=function(l){'use strict';for(var m=0;m<this.faceboxes.length;++m)if(this.faceboxes[m].id===l)return this.faceboxes[m];return null;};k.prototype.setupFaceboxSuggestionHandlers=function(l,m){'use strict';var n=c('DOM').find(m,"a._570w"),o=c('DOM').find(m,"a._570x");this.handlers.push(c('Event').listen(n,'click',function(p){var q=this._getCurrentFaceboxID(),r=this.version===c('PhotosConst').VIEWER_PERMALINK?c('FaceboxSourceConstants').PERMALINK_DISMISS:c('FaceboxSourceConstants').SNOWLIFT_DISMISS;this.dismissFaceboxSuggestion(l.id.replace('face:',''),m.getAttribute('data-id'),this.photoData.owner,r);this.removeSuggestionFromTagger();this.hideTagger();c('DOM').remove(this.getFaceboxSuggestionFromFaceboxElem(l.node));c('Arbiter').inform('PhotoTagger.TAG_SUGGESTION_REJECTED/'+q);}.bind(this)),c('Event').listen(o,'click',function(p){var q=this._getCurrentFaceboxID(),r={uid:m.getAttribute('data-id'),text:m.getAttribute('data-text')},s=this.tokenizer.createToken(r),t=this.version===c('PhotosConst').VIEWER_PERMALINK?c('FaceboxSourceConstants').PERMALINK_SUGGEST:c('FaceboxSourceConstants').SNOWLIFT_SUGGEST;this.saveTag(null,s,t);c('Arbiter').inform('PhotoTagger.TAG_SUGGESTION_CONFIRMED/'+q);}.bind(this)));};k.prototype._getCurrentFaceboxID=function(){'use strict';return this.currentFacebox&&this.currentFacebox.id.substring(5);};k.getInstance=function(l){'use strict';return k.instances[l];};k.resetAlbumTaggingSuggestions=function(l){'use strict';var m=k.getInstance(l);m&&m.resetAlbumTaggingSuggestions();};Object.assign(k,{instances:{}});Object.assign(k.prototype,{TAG_BOX_SIZE:100,EPSILON:.0025,HUGE_FACE_THRESH:90,HUGE_FACE_SHRINK_FACTOR:.6,elemNames:{6:{addTagLink:'div.fbPhotosPhotoOwnerButtons',overlayActions:'div.snowliftOverlayBar'}}});f.exports=k;}),null);
__d('PhotoPermalink',['csx','$','Arbiter','Assert','AsyncRequest','Bootloader','CSS','DOM','Event','KeyEventController','Keys','PageTransitions','Parent','PhotoPermalinkURI','PhotosConst','PhotoSessionLog','PhotoStreamCache','PhotosUtils','PhotoTagger','PhotoTagSearchPivotLogger','PhotoViewer','PhotoWarningScreen','PhotoWarningScreenConfig','PhotoWarningScreenMixin','Scroll','Style','Vector','classWithMixins','emptyFunction','ge','goURI','mixin'],(function a(b,c,d,e,f,g,h){var i,j;i=babelHelpers.inherits(k,c('classWithMixins')(c('PhotoViewer'),c('mixin')(c('PhotoWarningScreenMixin'))));j=i&&i.prototype;function k(){'use strict';j.constructor.call(this);this._uriStack=[];this.replaceUrl=false;this.payloadInitialized=false;this._seenTags={};}k.prototype.init=function(l){'use strict';this.stream=new (c('PhotoStreamCache'))();this.stream.init(c('PhotosConst').VIEWER_PERMALINK,'PhotoViewerPagelet','pagelet_photo_viewer');this.reset();this.root=c('$')('fbPhotoPageContainer');this.header=c('$')('fbPhotoPageHeader');this.stageWrapper=c('DOM').find(this.root,'.stageContainer');this.videoStage=c('DOM').find(this.stageWrapper,'div.videoStage');this.buttonActions=c('DOM').find(this.root,'div.stageButtons');this.viewLargerLink=c('DOM').scry(this.root,'a.fbPhotoViewLarger').pop();this.feedback=c('ge')('fbPhotoPageFeedback');this.image=c('ge')('fbPhotoImage');this.errorBox=c('ge')('fbPhotoPageError');this.actionList=c('ge')('fbPhotoPageActions');this.stageActions=c('DOM').find(this.root,'div.stageActions');this.photoContentContainer=c('$')('fbxPhotoContentContainer');this.photoImageStage=c('DOM').find(this.root,'.fbPhotoImageStage');this.existingPhotoWarning=c('DOM').scry(this.root,"._2v00").pop();this.initGraphicWarningDOM(this.existingPhotoWarning||l.graphic_warning_markup);this.showingTypeaheadSuggestions=false;this.loadingStates={image:false,html:false};this.unhiliteTimer=null;this.source=null;if(this.image)this.imageLoadListener=c('Event').listen(this.image,'load',this.adjustForNewData.bind(this));this.pageHandlers=[c('Event').listen(this.root,'mouseout',this.mouseOutListener.bind(this)),c('Event').listen(this.root,'mousemove',this.mouseMoveListener.bind(this)),c('Event').listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),c('Event').listen(this.buttonActions,'click',this.buttonListener.bind(this)),c('Event').listen(this.actionList,'click',this.rotateListener.bind(this)),c('Event').listen(this.feedback,'click',function(event){var m=event.getTarget();if(c('Parent').byClass(m,'like_link')||c('Parent').byClass(m,'UFILikeLink')&&c('Parent').byClass(m,'UIActionLinks'))c('CSS').toggleClass(c('DOM').find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this))];c('PageTransitions').registerHandler(this.transitionHandler.bind(this));c('KeyEventController').registerKey('LEFT',this.goNav.bind(this));c('KeyEventController').registerKey('RIGHT',this.goNav.bind(this));c('PhotoSessionLog').initLogging(c('PhotoSessionLog').PERMALINK);this._showHover=l.pivot_hover;c('Arbiter').subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));c('Arbiter').subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));this.adjustForNewData();};k.prototype.getEventPrefix=function(){'use strict';return 'PhotoPermalink';};k.prototype.getSourceString=function(){'use strict';return 'permalink';};k.prototype.getViewerSource=function(){'use strict';return this.source;};k.prototype.getViewerSet=function(){'use strict';return this.stream.getPhotoSet();};k.prototype.getVersionConst=function(){'use strict';return c('PhotosConst').VIEWER_PERMALINK;};k.prototype.getGraphicWarningContainer=function(){'use strict';return this.photoContentContainer;};k.prototype.getGraphicWarningHiddenContent=function(){'use strict';return this.photoImageStage;};k.prototype.saveTagsFromPayload=function(l){'use strict';this.storeFromData(l);if('data' in l&&this.stream.getCursor() in l.data)this.swapData();};k.prototype.goNav=function(event){'use strict';var l=c('Event').getKeyCode(event)||event.getTarget(),m=event.type==='click'&&c('Parent').byClass(l,'stageWrapper')&&!c('Parent').byClass(l,'tagBoxPending')&&!c('Parent').byClass(l,'tagBoxPendingResponse')&&!c('Parent').byClass(l,'uiButtonGroup');if(m&&c('CSS').hasClass(this.root,'taggingMode'))return false;if(l==c('Keys').LEFT){this.page(-1);}else if(l==c('Keys').RIGHT||m)this.page(1);return false;};k.prototype.pagerClick=function(l){'use strict';if(l=='prev'){this.page(-1);}else if(l=='next')this.page(1);return false;};k.prototype.setLoadingState=function(l,m){'use strict';switch(l){case k.STATE_IMAGE_DATA:this.loadingStates[l]=m;c('CSS').conditionClass(this.root,'imageLoading',m);break;case k.STATE_HTML:this.loadingStates[l]=m;c('CSS').conditionClass(this.root,'dataLoading',m);break;}};k.prototype.checkState=function(l){'use strict';if(l!=k.STATE_ERROR&&!this.loadingStates[l])return;switch(l){case k.STATE_IMAGE_DATA:var m=this.stream.getCurrentImageData();if(m){if(m.url){this.switchImage(m.url,true);}else if(m.video)this.switchVideo(m.video,true);this.setLoadingState(l,false);}break;case k.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(l,false);}break;default:if(this.stream.errorInCurrent()){if(this.image)c('CSS').hide(this.image);c('CSS').show(this.errorBox);}break;}};k.prototype.reHilitePendingTag=function(){'use strict';var l=c('ge')(this.hilitedTag);if(l&&c('CSS').hasClass(l,'showPendingTagName'))return;var m=c('DOM').scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(m)this.switchHilitedTags(m.id);};k.prototype.setReachedLeftEnd=function(){'use strict';this.stream.setReachedLeftEnd();};k.prototype.setReachedRightEnd=function(){'use strict';this.stream.setReachedRightEnd();};k.prototype.isPagingAllowed=function(l){'use strict';return this.stream.isValidMovement(l)&&!c('CSS').hasClass(this.root,'croppingMode');};k.prototype.page=function(l,m){'use strict';if(!this.isPagingAllowed(l)||!this.stream.nonCircularPhotoSetCanPage(l))return;this._seenTags={};this.unhiliteAllTags();var n=this.getVideoOnStage();if(n)this.switchVideo(n,false);this.recacheData();this.stream.moveCursor(l);if(this.image)c('CSS').hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(k.STATE_HTML,true);c('CSS').show(this.errorBox);return;}var o=this.stream.getCurrentImageData();if(o){if(o.url){if(l!==0)if(o.info.isgraphic){this.showGraphicWarning();c('PhotoWarningScreen').logFilterEvent(c('PhotoWarningScreenConfig').ObjectionableEvents.SHOW_WARNING_SCREEN,[o.info.fbid],c('PhotoWarningScreenConfig').Types.GRAPHIC);}else this.hideGraphicWarning();this.switchImage(o.url,true);if(this.viewLargerLink)this.viewLargerLink.setAttribute('href',o.info.permalink);}else if(o.video)this.switchVideo(o.video,true);if(!m){this.replaceUrl=true;c('goURI')(o.info.permalink);}}else{this.waitForLoadCount++;this.setLoadingState(k.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(k.STATE_HTML,true);c('Arbiter').inform('PhotoPermalink.PAGE');};k.prototype.transitionHandler=function(l){'use strict';if(!c('PhotoPermalinkURI').isValid(l))return false;var m=l.getQualifiedURI().toString();if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(m);c('PageTransitions').transitionComplete();return true;}var n=this._uriStack.length;if(n>=2&&this._uriStack[n-2]===m)this._uriStack.pop();var o=this.stream.getCursorForURI(l.getUnqualifiedURI().toString());if(o){var p=this.stream.getRelativeMovement(o);this.page(p,true);c('PageTransitions').transitionComplete();return true;}return false;};k.prototype.recacheData=function(l){'use strict';if(!this.loadingStates.html){var m=this.stream.getCurrentHtml();for(var n in m){var o=c('ge')(n);if(o)m[n]=Array.from(o.childNodes);if(l!==true&&n!=='fbPhotoPageHeader'&&o)c('DOM').empty(c('$')(n));}}};k.prototype.getCurrentPhotoInfo=function(){'use strict';var l=this.stream.getCurrentImageData();return l&&l.info;};k.prototype.getVideoOnStage=function(){'use strict';var l=this.stream.getCurrentImageData();return l&&l.video;};k.prototype.switchImage=function(l,m){'use strict';c('CSS').hide(this.image);c('CSS').hide(this.errorBox);var n=this.stream&&this.stream.getCurrentImageData();if(n){c('PhotoSessionLog').addPhotoView(n.info);if(this._showHover){var o=this.stream.getCurrentExtraData();if(o)c('PhotoTagSearchPivotLogger').logImageImpression('permalink',String(this.stream.getCursor()),Object.keys(o.tagRects));}}var p=c('DOM').create('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:l});c('DOM').replace(this.image,p);this.image=p;if(this.imageLoadListener)this.imageLoadListener.remove();this.imageLoadListener=c('Event').listen(this.image,'load',this.adjustForNewData.bind(this));if(m)this.stream.preloadImages();};k.prototype.switchVideo=function(l,m){'use strict';var n='swf_'+l;if(m){c('CSS').addClass(this.stageWrapper,'showVideo');this.videoStage.id=l;if(window[n]&&!c('ge')(n))window[n].write(l);}else{this.videoStage.id='fbPageVideoStage';window[n].addVariable('video_autoplay',0);c('DOM').empty(this.videoStage);c('CSS').removeClass(this.stageWrapper,'showVideo');}};k.prototype.swapData=function(){'use strict';if(this.dataLoadTimer){this.setLoadingState(k.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var l,m=this.stream.getCurrentHtml();if(m){for(var n in m){var o=m[n];if(Array.isArray(o)&&o.length===1&&o[0]===undefined)continue;l=c('ge')(n);l&&c('DOM').setContent(l,m[n]);}c('Arbiter').inform('PhotoPermalink.DATA_CHANGE',this.stream.getCurrentImageData().info,c('Arbiter').BEHAVIOR_STATE);if(this.stream.getCurrentExtraData()){c('Arbiter').inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),c('Arbiter').BEHAVIOR_STATE);var p=this.stream.getCurrentExtraData();if(p&&p.source!==undefined){this.source=p.source;c('PhotoSessionLog').setSource(this.source);}}this.setLoadingState(k.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();};k.prototype.clearTimer=function(l){'use strict';this.dataLoadTimer=false;l&&this.swapData();};k.prototype.adjustForNewData=function(){'use strict';if(!this.image)return;var l=c('DOM').scry(this.stageWrapper,'div.tagsWrapper')[0],m=c('Vector').getElementDimensions(this.image);if(l){c('Style').set(l,'width',m.x+'px');c('Style').set(l,'height',m.y+'px');}};k.prototype.fetchInitBucket=function(l){'use strict';if(!this.stream.isLoaded())return;this.stream.fetch(l,true);};k.prototype.addPhotoFbids=function(l,m,n){'use strict';var o=this.stream.getCursor()===null;this.stream.attachToFbidsList(l,m,n);if(n&&o)this.page(0);};k.prototype.attachTagger=function(l){'use strict';c('DOM').appendContent(this.stageActions,l);};k.prototype.storeFromData=function(l){'use strict';var m=this.stream.storeToCache(l);if('init' in l){c('PhotoSessionLog').setPhotoSet(this.stream.getPhotoSet());c('PhotoSessionLog').setLogFbids(true);c('PhotoSessionLog').addPhotoView(this.stream.getCurrentImageData().info);if(this._showHover){var n=this.stream.getCurrentExtraData();if(n)c('PhotoTagSearchPivotLogger').logImageImpression('permalink',String(this.stream.getCursor()),Object.keys(n.tagRects));}}if('error' in m){this.checkState(k.STATE_ERROR);return;}if('image' in m)this.checkState(k.STATE_IMAGE_DATA);if('data' in m)this.checkState(k.STATE_HTML);if(!this.payloadInitialized&&this.stream.getCurrentExtraData()){this.payloadInitialized=true;c('Arbiter').inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),c('Arbiter').BEHAVIOR_STATE);}};k.prototype.handleServerError=function(l,m){'use strict';c('DOM').setContent(this.errorBox,l);this.storeFromData(m);};k.prototype.updateTotalCount=function(l,m,n){'use strict';var o=c('ge')('fbPhotoPagePositionAndCount');o&&c('DOM').setContent(o,n);this.stream.setTotalCount(l);this.stream.setFirstCursorIndex(m);};k.prototype.buttonListener=function(event){'use strict';var l=event.getTarget();if(c('Parent').byClass(l,'likeButton')){var m=c('DOM').scry(this.feedback,'button.like_link')[0];if(!m)m=c('DOM').scry(this.feedback,'a.UFILikeLink')[0];m&&m.click();}else if(c('Parent').byClass(l,'commentButton')){var n=c('DOM').scry(this.feedback,'div.commentBox textarea')[0];if(!n)n=c('DOM').scry(this.feedback,'li.UFIAddComment textarea')[0];if(n){n.focus();c('Scroll').setTop(this.root,this.root.scrollHeight);}}};k.prototype.rotateListener=function(event){'use strict';var l=event.getTarget();if(c('Parent').byClass(l,'rotateRight')){this.rotate('right');}else if(c('Parent').byClass(l,'rotateLeft'))this.rotate('left');};k.prototype.stageClickListener=function(event){'use strict';var l=event.getTarget(),m=c('CSS').hasClass(l,'faceBox'),n=c('Parent').byClass(l,'fbPhotoTagApprovalBox')||c('Parent').byClass(l,'faceboxSuggestion')||c('Parent').byClass(l,'videoStage')||c('Parent').byClass(l,'tag')||c('Parent').byClass(l,'typeaheadWrapper')||c('Parent').byClass(l,'photoTagLink')||c('Parent').byClass(l,'photoTagTypeahead')||c('Parent').byClass(l,'fbPhotoViewLarger')||m;if(m){if(!this.showingTypeaheadSuggestions){var o=this.getTagger();o.updateWithSuggestions();setTimeout(function(){c('DOM').find(o.tagger,'input.textInput').focus();}.bind(this),0);}this.showingTypeaheadSuggestions=!this.showingTypeaheadSuggestions;}if(n){return true;}else this.goNav(event);};k.prototype.rotate=function(l){'use strict';var m=this.stream.getCursor();if(this.getVideoOnStage()){var n=l=='left'?270:90;c('Assert').isTruthy(this.videoRotateURI,"Video rotate URI not set.");c('Bootloader').loadModules(["VideoRotate"],function(p){new p(m,this.videoRotateURI).motionRotate(n);}.bind(this),'PhotoPermalink');return;}var o=babelHelpers['extends']({fbid:m,opaquecursor:this.stream.getOpaqueCursor(m),cs_ver:c('PhotosConst').VIEWER_PERMALINK},this.stream.getPhotoSetQuery());o[l]=1;this.setLoadingState(k.STATE_IMAGE_DATA,true);c('CSS').hide(this.image);new (c('AsyncRequest'))('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(o).setFinallyHandler(this.rotateComplete.bind(this,m)).send();};k.prototype.rotateComplete=function(l,m){'use strict';if(l==this.stream.getCursor()){this.setLoadingState(k.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}};k.prototype.mouseOutListener=function(event){'use strict';var l=event.getTarget(),m=event.getRelatedTarget(),n=c('Parent').byClass(l,'stageActions'),o=c('Parent').byClass(l,'stageWrapper'),p=c('Parent').byClass(m,'stageActions'),q=c('Parent').byClass(m,'stageWrapper'),r=c('Parent').byClass(m,'uiContextualLayer'),s=!q&&!r&&o&&!p||n&&!q;if(s)this.unhiliteAllTags(true);};k.prototype.mouseMoveListener=function(event){'use strict';var l=event.getTarget(),m=c('Parent').byClass(l,'faceboxSuggestion')||c('Parent').byClass(l,'tagPointer')||c('Parent').byClass(l,'typeaheadWrapper')||c('Parent').byClass(l,'photoTagTypeahead')||c('Parent').byClass(l,'arrow');if(!c('Parent').byClass(l,'stageActions')&&!c('Parent').byClass(l,'stageWrapper')||m)return;this.hiliteTagsOnMouseMove(event);};k.prototype.unhiliteAllTags=function(l,event){'use strict';c('DOM').scry(this.stageWrapper,'div.tagsWrapper div.hover').forEach(function(n){if(l&&c('CSS').hasClass(n,'tagBoxPending'))return;c('CSS').removeClass(n,'hover');});if(l)return;c('DOM').scry(this.stageWrapper,'div.tagsWrapper div.otherActive').forEach(function(n){c('CSS').removeClass(n,'otherActive');});if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;this.showingTypeaheadSuggestions=false;if(!c('CSS').hasClass(this.root,'taggingMode')){var m=this.getTagger();if(m){m.hideTagger();m.setCurrentFacebox(null);}}};k.prototype.getTagger=function(){'use strict';return c('PhotoTagger').getInstance(c('PhotosConst').VIEWER_PERMALINK);};k.prototype.switchHilitedTags=function(l,m){'use strict';this.unhiliteAllTags();this.hiliteAllBoxes();var n=c('ge')(l);if(n){this.hilitedTag=l;if(!c('CSS').hasClass(this.root,'taggingMode')&&c('PhotosUtils').isFacebox(this.hilitedTag)){var o=this.getTagger();if(o){c('CSS').addClass(n,'hover');var p=o.getFacebox(l);o.setCurrentFacebox(p);if(p)o.addTagFromFacebox(p);}}else c('CSS').addClass(n,'hover');if(c('CSS').hasClass(n,'tagBoxPending')&&!c('CSS').hasClass(n,'showPendingTagName')&&m===true){c('DOM').scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').forEach(function(q){c('CSS').removeClass(q,'showPendingTagName');});c('CSS').addClass(n,'showPendingTagName');}}};k.prototype.hiliteTagsOnMouseMove=function(event){'use strict';if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var l=event.getTarget();if(c('Parent').byClass(l,'fbPhotoPageTagApproval')||c('Parent').byClass(l,'tagPointer'))return;var m=c('Parent').byClass(l,'tagBoxPending'),n=false;if(this.hilitedTag){var o=c('ge')(this.hilitedTag);n=o&&c('CSS').hasClass(o,'tagBoxPending');}var p=!this.hilitedTag&&m||!n&&m;if(p){this.switchHilitedTags(m.id);return;}if(m&&m.id==this.hilitedTag)return;var q=250,r=c('PhotosUtils').absoluteToNormalizedPosition(this.image,c('Vector').getEventPosition(event)),s=c('PhotosUtils').getNearestBox(this.stream.getCurrentExtraData().tagRects,r);if(!s){if(!n){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var t=null;if(n){var u={};u[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];t=c('PhotosUtils').getNearestBox(u,r);}if(t!==null&&n)return;if(this.hilitedTag!=s)if(n){this.unhiliteTimer=setTimeout(this.unhiliteAllTags.bind(this,false,event),q);}else{if(this._showHover&&!this._seenTags[s]){this._seenTags[s]=true;c('PhotoTagSearchPivotLogger').logPivotImpression('permalnk','pivot_impression',s);}this.switchHilitedTags(s);}};k.prototype.updateTagBox=function(l,m){'use strict';this.unhiliteAllTags();var n=c('ge')(l);if(!n)return;c('CSS').addClass(n,'tagBox');c('CSS').addClass(n,'tagBoxPendingResponse');c('CSS').removeClass(n,'tagBoxPending');c('CSS').hide(c('DOM').find(n,'span.tagForm'));if(m){c('CSS').show(c('DOM').find(n,'span.tagApproved'));}else c('CSS').show(c('DOM').find(n,'span.tagIgnored'));};k.prototype.reset=function(){'use strict';while(this.pageHandlers&&this.pageHandlers.length)this.pageHandlers.pop().remove();if(this.imageLoadListener){this.imageLoadListener.remove();this.imageLoadListener=null;}c('KeyEventController').getInstance().resetHandlers();};k.prototype.onHiliteTag=function(l,m){'use strict';if(m.version!=c('PhotosConst').VIEWER_PERMALINK)return;var n=m.tag;if(n){this.switchHilitedTags(n,true);}else this.unhiliteAllTags();};k.prototype.onUpdateTagBox=function(l,m){'use strict';if(m.version==c('PhotosConst').VIEWER_PERMALINK)this.updateTagBox(m.id,m.approve);};k.prototype.setHasLocation=function(l){'use strict';c('CSS').conditionClass(this.root,'hasLocation',l);};k.getInstance=function(){'use strict';if(!k._instance)k._instance=new k();return k._instance;};k.addPhotoFbids=function(l,m,n){'use strict';k.getInstance().addPhotoFbids(l,m,n);};k.setReachedLeftEnd=function(){'use strict';k.getInstance().setReachedLeftEnd();};k.setReachedRightEnd=function(){'use strict';k.getInstance().setReachedRightEnd();};k.attachTagger=function(l){'use strict';k.getInstance().attachTagger(l);};k.disableAjaxPipeForVideo=function(){'use strict';var l=k.getInstance();if(l.stream)l.stream.setUseAjaxPipe(false);};k.init=function(l){'use strict';k.getInstance().init(l||{});};k.recacheData=function(l){'use strict';k.getInstance().recacheData(l);};k.saveTagsFromPayload=function(l){'use strict';k.getInstance().saveTagsFromPayload(l);};k.saveTagsFromPayloadDelayed=function(l){'use strict';setTimeout(k.saveTagsFromPayload.bind(null,l),2000);};k.handleServerError=function(l,m){'use strict';k.getInstance().handleServerError(l,m);};k.setHasLocation=function(l){'use strict';k.getInstance().setHasLocation(l);};k.storeFromData=function(l){'use strict';k.getInstance().storeFromData(l);};k.swapData=function(){'use strict';k.getInstance().swapData();};k.updateTotalCount=function(l,m,n){'use strict';k.getInstance().updateTotalCount(l,m,n);};k.setVideoRotateURI=function(l){'use strict';k.getInstance().videoRotateURI=l;};Object.assign(k,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,_instance:null,touchMarkup:c('emptyFunction')});f.exports=k;}),null);
__d('PhotoTags',['csx','cx','Arbiter','CSS','DOM','Event','Parent','PhotosConst','ge'],(function a(b,c,d,e,f,g,h,i){function j(k,l,m){'use strict';this.tagTargets=k;this.tagBox=l;this.version=m||c('PhotosConst').VIEWER_PERMALINK;this.handlers=[];this.tagTargets.forEach(function(n){this.handlers.push(c('Event').listen(n,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==c('PhotosConst').VIEWER_SNOWLIFT)this.subscriptions.push(c('Arbiter').subscribe("PhotoSnowlift.PAGE",this.hideTags.bind(this)));}j.prototype.showTag=function(event){'use strict';var k=event.getTarget(),l=c('CSS').hasClass(k,'taggee'),m=c('CSS').matchesSelector(k,"._54ru"),n=null,o=null;if(l){n=k.getAttribute('data-tag');o=k.getAttribute('data-tagtype');}else if(m){var p=c('Parent').byTag(k,'a');n=p&&p.getAttribute('data-tag');}if(!n){k=c('Parent').byClass(k,'taggee');if(k){n=k.getAttribute('data-tag');o=k.getAttribute('data-tagtype');}}var q=this.version==c('PhotosConst').VIEWER_PERMALINK?'perm:tag:'+n:'tag:'+n,r=q&&c('ge')(q);if(r){if(o==='product'){c('CSS').addClass(r,'hover');}else c('CSS').addClass(r,'showTag');c('CSS').addClass(this.tagBox,'showingTag');}};j.prototype.hideTags=function(){'use strict';c('CSS').removeClass(this.tagBox,'showingTag');c('DOM').scry(this.tagBox,'div.showTag').forEach(function(k){c('CSS').removeClass(k,'showTag');});c('DOM').scry(this.tagBox,'div.hover').forEach(function(k){c('CSS').removeClass(k,'hover');});};j.prototype.destroy=function(){'use strict';for(var k in this.handlers)this.handlers[k].remove();this.subscriptions.forEach(c('Arbiter').unsubscribe.bind(c('Arbiter')));};f.exports=j;}),null);
__d('legacy:PhotoTags',['PhotoTags'],(function a(b,c,d,e,f,g){b.PhotoTags=c('PhotoTags');}),3);